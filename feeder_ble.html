<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dispensador de alimento - LUMAGI</title>
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif; padding:16px; max-width:780px; margin:auto; background: #FFF7ED}
    h1{font-size:20px;margin-bottom:4px}
    .card{border:1px solid #000000;border-radius:8px;padding:12px;margin-bottom:12px;background:#e8d9d9;}
    label{display:block;margin:6px 0;font-size:14px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    #list .item{padding:8px;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
    #log{height:160px; overflow:auto; background:#ffffff; color:#070707; padding:8px; font-family:monospace; border-radius:6px}
    .btn{cursor:pointer;background:#8b3232;color:#ffffff;border:0;padding:8px 10px;border-radius:6px}
    .btn:disabled{opacity:0.6}
    small{color:#666}
  </style>
</head>
<body>
  <h1>Dispensador de alimento</h1>

  <div class="card">
    <label>Hora
      <input id="time" type="time" value="07:00">
    </label>

    <label>Días (0=Dom,1=Lun,...6=Sáb). Dejar vacío = todos:
      <input id="days" type="text" placeholder="ej: 1,3,5">
      <small>Ejemplo: 1,2,3  — o vacío para todos</small>
    </label>

    <label>Porciones
      <input id="porciones" type="number" min="1" value="1">
    </label>

    <div style="margin-top:8px">
      <button id="add" class="btn">Agregar horario</button>
      <button id="clear" style="margin-left:8px">Limpiar todos</button>
    </div>
  </div>

  <div class="card">
    <h3>Horarios</h3>
    <div id="list"></div>
    <small id="count"></small>
  </div>

  <div class="card">
    <label><input id="useChunk" type="checkbox"> Usar chunking (recomendado si la lista es grande)</label>
    <label>Service UUID (BLE): <input id="svc" type="text" value="6e400001-b5a3-f393-e0a9-e50e24dcca9e" style="width:320px"></label>
    <label>Char UUID (WRITE): <input id="chr" type="text" value="6e400002-b5a3-f393-e0a9-e50e24dcca9e" style="width:320px"></label>
    <div style="margin-top:8px;">
      <button id="send" class="btn">Enviar por BLE</button>
      <button id="scan" style="margin-left:8px">Escanear dispositivos (mostrar lista)</button>
    </div>
    <p id="status" style="margin-top:8px">Estado: listo</p>
  </div>

  <div class="card">
    <h3>Registro / Log</h3>
    <div id="log"></div>
  </div>

<script>
/* feeder_ble.html - JS
   Funcionalidad:
   - Crear horarios (id, time, days array, porciones, enabled)
   - Enviar JSON por BLE al servicio/char indicados
   - Opcional: chunking -> envía paquetes {"chunk":i,"total":n,"data":"<base64>"}
*/

// utils
const logEl = document.getElementById('log');
function log(msg){
  const ts = new Date().toLocaleString();
  logEl.innerText += `[${ts}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}
function setStatus(s){ document.getElementById('status').innerText = 'Estado: ' + s; }

// UI elements
const timeEl = document.getElementById('time');
const daysEl = document.getElementById('days');
const porEl = document.getElementById('porciones');
const addBtn = document.getElementById('add');
const listEl = document.getElementById('list');
const countEl = document.getElementById('count');
const clearBtn = document.getElementById('clear');
const sendBtn = document.getElementById('send');
const scanBtn = document.getElementById('scan');
const useChunkEl = document.getElementById('useChunk');
const svcEl = document.getElementById('svc');
const chrEl = document.getElementById('chr');

let schedules = [];

// render list
function render(){
  listEl.innerHTML = '';
  schedules.forEach((s, idx)=>{
    const it = document.createElement('div');
    it.className = 'item';
    const left = document.createElement('div');
    left.innerHTML = `<b>${s.time}</b> &nbsp; dias: ${s.days.length ? s.days.join(',') : 'Todos'} &nbsp; porciones: ${s.porciones}`;
    const btn = document.createElement('button');
    btn.innerText = 'Eliminar';
    btn.onclick = ()=>{ schedules.splice(idx,1); render(); }
    it.appendChild(left);
    it.appendChild(btn);
    listEl.appendChild(it);
  });
  countEl.innerText = `Total horarios: ${schedules.length}`;
}

// add schedule
addBtn.onclick = ()=>{
  const time = timeEl.value;
  if(!time){ alert('Selecciona hora (HH:MM)'); return; }
  const daysStr = daysEl.value.trim();
  let days = [];
  if(daysStr !== ''){
    days = daysStr.split(',').map(x=>parseInt(x.trim())).filter(n=>!isNaN(n) && n>=0 && n<=6);
  }
  const por = parseInt(porEl.value) || 1;
  const id = 's' + Date.now();
  schedules.push({id, time, days, porciones: por, enabled:true});
  render();
  log('Horario agregado: ' + JSON.stringify({time, days, porciones: por}));
};

// clear
clearBtn.onclick = ()=>{ if(confirm('Eliminar todos los horarios?')){ schedules=[]; render(); } };

// Helper: base64 from Uint8Array
function uint8ToBase64(u8){
  let CHUNK_SIZE = 0x8000;
  let index = 0;
  let length = u8.length;
  let result = '';
  while (index < length) {
    let slice = u8.subarray(index, Math.min(index + CHUNK_SIZE, length));
    result += String.fromCharCode.apply(null, slice);
    index += CHUNK_SIZE;
  }
  return btoa(result);
}

// BLE send
async function writeCharacteristic(device, serviceUuid, charUuid, data) {
  // data: Uint8Array or ArrayBuffer
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(serviceUuid);
  const char = await service.getCharacteristic(charUuid);
  await char.writeValue(data);
  await server.disconnect();
}

async function sendSingleWrite(device, serviceUuid, charUuid, payloadBytes){
  setStatus('Enviando (single write)...');
  try{
    await writeCharacteristic(device, serviceUuid, charUuid, payloadBytes);
    log('Enviado (single write). Tamaño: ' + payloadBytes.byteLength + ' bytes');
    setStatus('Envío completado (single).');
  }catch(e){
    log('Error single write: ' + e);
    setStatus('Error single write');
    throw e;
  }
}

async function sendChunked(device, serviceUuid, charUuid, payloadBytes, chunkSize=180){
  // divide payloadBytes (Uint8Array) en chunks y envía paquetes JSON: {"chunk":i,"total":n,"data":"<base64>"}
  const u8 = new Uint8Array(payloadBytes);
  const chunks = [];
  for(let i=0;i<u8.length;i+=chunkSize){
    chunks.push(u8.subarray(i, i+chunkSize));
  }
  const total = chunks.length;
  setStatus(`Enviando por chunks (${total})...`);
  try{
    // conect once, get characteristic, then sequential writes (faster and avoids repeated connect/disconnect)
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);
    const char = await service.getCharacteristic(charUuid);
    for(let i=0;i<total;i++){
      const part = chunks[i];
      const b64 = uint8ToBase64(part);
      const pkt = JSON.stringify({chunk:i+1, total: total, data: b64});
      const enc = new TextEncoder().encode(pkt);
      await char.writeValue(enc);
      log(`Chunk ${i+1}/${total} enviado (${enc.byteLength} bytes)`);
      // pequeño delay para dar tiempo al ESP32 a procesar
      await new Promise(res => setTimeout(res, 80));
    }
    await server.disconnect();
    setStatus('Envío completado (chunked).');
    log('Chunked finalizado.');
  }catch(e){
    log('Error chunked send: ' + e);
    setStatus('Error chunked');
    throw e;
  }
}

// pick device
async function selectDevice(serviceUuid) {
  setStatus('Solicitando permiso BLE...');
  try{
    const device = await navigator.bluetooth.requestDevice({
      filters: [{services: [serviceUuid]}],
      optionalServices: [serviceUuid]
    });
    return device;
  }catch(e){
    // some browsers throw if no filter matched or user cancels; provide fallback prompt:
    throw e;
  }
}

// scan (show available devices) - best-effort: navigator.bluetooth.requestDevice with acceptAllDevices if needed
scanBtn.onclick = async ()=>{
  setStatus('Buscando (requestDevice)...');
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [svcEl.value]
    });
    log('Seleccionado: ' + (device.name || device.id));
    setStatus('Dispositivo seleccionado: ' + (device.name || device.id));
  }catch(e){
    log('Escaneo cancelado / falló: ' + e);
    setStatus('Escaneo cancelado');
  }
};

// send button
sendBtn.onclick = async ()=>{
  if(schedules.length === 0){ alert('No hay horarios para enviar'); return; }
  const svc = svcEl.value.trim(); const chr = chrEl.value.trim();
  if(!svc || !chr){ alert('Falta Service o Char UUID'); return; }

  const payload = JSON.stringify(schedules);
  const enc = new TextEncoder().encode(payload);
  const useChunk = useChunkEl.checked;

  setStatus('Preparando payload: ' + enc.byteLength + ' bytes');
  log('Payload JSON size: ' + enc.byteLength + ' bytes');

  try{
    // pick device (service filter)
    const device = await selectDevice(svc);
    log('Dispositivo elegido: ' + (device.name || device.id));
    if(!useChunk){
      // try single write; if fails due to MTU, user can retry with chunking
      await sendSingleWrite(device, svc, chr, enc.buffer);
    } else {
      await sendChunked(device, svc, chr, enc.buffer, 180);
    }
  }catch(e){
    log('Error al enviar por BLE: ' + e);
    if(!useChunk){
      log('Si el payload es grande prueba activar "Usar chunking" y reenviar.');
    }
  }
};

// init
render();
setStatus('Listo. Usa Chrome (Android) o Chrome/Edge (PC).');

</script>
</body>
</html>
